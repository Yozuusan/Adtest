{% comment %}
  Adlign Metaobject Injector Snippet
  Ce snippet utilise les VRAIS metaobjects Shopify (pas des metafields)
  Il lit les donn√©es depuis les metaobjects avec le handle correspondant
{% endcomment %}

{% comment %} D√©tecter le param√®tre ?adlign_variant= dans l'URL {% endcomment %}
{% assign adlign_variant = request.query_string | split: 'adlign_variant=' | last | split: '&' | first %}

{% if adlign_variant and adlign_variant != '' %}
  {% comment %} Variante Adlign d√©tect√©e - chercher le metaobject correspondant {% endcomment %}
  
  {% comment %} R√©cup√©rer le metaobject avec le handle de la variante {% endcomment %}
  {% assign variant_metaobject = shop.metaobjects['adlign_variant'][adlign_variant] %}
  
  {% if variant_metaobject %}
    {% comment %} Metaobject trouv√© - extraire les donn√©es {% endcomment %}
    {% assign content_json = variant_metaobject.content_json.value | parse_json %}
    {% assign product_gid = variant_metaobject.product_gid.value %}
    
    {% if content_json %}
      {% comment %} Injecter les donn√©es du metaobject {% endcomment %}
      <script id="adlign-metaobject-data" type="application/json">
        {
          "adlign_variant": {{ adlign_variant | json }},
          "shop": {{ shop.permanent_domain | json }},
          "product_id": {{ product.id | json }},
          "metaobject_id": {{ variant_metaobject.id | json }},
          "variant_data": {
            "title": {{ content_json.title | json }},
            "subtitle": {{ content_json.subtitle | json }},
            "description_html": {{ content_json.description_html | json }},
            "hero_image": {{ content_json.hero_image | json }},
            "usp_list": {{ content_json.usp_list | json }},
            "cta_primary": {{ content_json.cta_primary | json }},
            "cta_secondary": {{ content_json.cta_secondary | json }},
            "badges": {{ content_json.badges | json }},
            "campaign_ref": {{ content_json.campaign_ref | json }},
            "theme_fingerprint": {{ content_json.theme_fingerprint | json }}
          },
          "backend_url": "{{ 'https://adtest-production.up.railway.app' | escape }}",
          "source": "metaobject"
        }
      </script>
      
      {% comment %} Charger le micro-kernel Adlign {% endcomment %}
      <script src="{{ 'adlign-micro-kernel.js' | asset_url }}" defer></script>
      
      {% comment %} Initialiser Adlign {% endcomment %}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof window.Adlign !== 'undefined') {
            window.Adlign.init();
          }
        });
      </script>
      
      {% comment %} Debug: afficher les donn√©es inject√©es {% endcomment %}
      {% if request.design_mode %}
        <div style="background: #e7f5e7; border: 1px solid #28a745; padding: 10px; margin: 10px 0; border-radius: 4px;">
          <strong>‚úÖ Mode Design - Metaobject Adlign trouv√©:</strong><br>
          Handle: {{ adlign_variant }}<br>
          Metaobject ID: {{ variant_metaobject.id }}<br>
          Product GID: {{ product_gid }}<br>
          Titre: {{ content_json.title }}<br>
          CTA: {{ content_json.cta_primary }}<br>
          <small>‚úÖ Donn√©es lues depuis le metaobject adlign_variant</small>
        </div>
      {% endif %}
      
    {% else %}
      {% comment %} Metaobject trouv√© mais pas de content_json valide {% endcomment %}
      {% if request.design_mode %}
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px;">
          <strong>‚ö†Ô∏è Mode Design - Metaobject trouv√© mais contenu invalide:</strong><br>
          Handle: {{ adlign_variant }}<br>
          Metaobject ID: {{ variant_metaobject.id }}<br>
          <small>‚ùå Le champ content_json est vide ou malform√©</small><br>
          <small>üí° Mettez √† jour le metaobject via l'API backend</small>
        </div>
      {% endif %}
    {% endif %}
    
  {% else %}
    {% comment %} Metaobject non trouv√© pour ce handle {% endcomment %}
    {% if request.design_mode %}
      <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 4px;">
        <strong>‚ö†Ô∏è Mode Design - Metaobject non trouv√©:</strong><br>
        Handle recherch√©: {{ adlign_variant }}<br>
        <small>‚ùå Aucun metaobject adlign_variant avec ce handle</small><br>
        <small>üí° Cr√©ez-le via l'API backend : POST /variants</small><br>
        <small>üîó URL: <code>{{ shop.permanent_domain }}/admin/content/entries</code></small>
      </div>
    {% endif %}
  {% endif %}
  
{% else %}
  {% comment %} Pas de variante Adlign - page normale {% endcomment %}
  {% if request.design_mode %}
    <div style="background: #d1ecf1; border: 1px solid #17a2b8; padding: 10px; margin: 10px 0; border-radius: 4px;">
      <strong>‚ÑπÔ∏è Mode Design - Page normale (metaobjects):</strong><br>
      <small>Ajoutez ?adlign_variant=handle √† l'URL pour tester une variante</small><br>
      <small>üí° Exemple: ?adlign_variant=bf-2025</small><br>
      <small>üì¶ Cette version utilise les metaobjects Shopify natifs</small>
    </div>
  {% endif %}
{% endif %}

{% comment %} Fallback vers l'ancien syst√®me metafields si n√©cessaire {% endcomment %}
{% unless variant_metaobject %}
  {% if adlign_variant and adlign_variant != '' %}
    {% comment %} Essayer l'ancien syst√®me avec metafields comme fallback {% endcomment %}
    {% assign adlign_settings = product.metafields.adlign_data.settings %}
    {% if adlign_settings %}
      {% assign variant_data = adlign_settings[adlign_variant] %}
      {% if variant_data %}
        <script id="adlign-fallback-data" type="application/json">
          {
            "adlign_variant": {{ adlign_variant | json }},
            "shop": {{ shop.permanent_domain | json }},
            "product_id": {{ product.id | json }},
            "variant_data": {{ variant_data | json }},
            "backend_url": "{{ 'https://adtest-production.up.railway.app' | escape }}",
            "source": "metafield_fallback"
          }
        </script>
        
        <script src="{{ 'adlign-micro-kernel.js' | asset_url }}" defer></script>
        
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.Adlign !== 'undefined') {
              window.Adlign.init();
            }
          });
        </script>
        
        {% if request.design_mode %}
          <div style="background: #ffeaa7; border: 1px solid #fdcb6e; padding: 10px; margin: 10px 0; border-radius: 4px;">
            <strong>üîÑ Mode Design - Fallback metafield activ√©:</strong><br>
            Handle: {{ adlign_variant }}<br>
            <small>‚ö° Utilise l'ancien syst√®me metafields comme fallback</small><br>
            <small>üí° Migration vers metaobjects recommand√©e</small>
          </div>
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endunless %}